#!/usr/bin/env ruby

# <%= $cmake["NoEditWarning"] %>
#

##########################################################
# installLocally.rb
# 
# Install BrowserPlus locally
#
# Created by Gordon Durand on Fri Oct 5 2007
# Copyright (c) 2007 Yahoo! Inc.  All rights reserved
##########################################################

require 'fileutils'
require 'pathname'
require 'rbconfig'
include Config

if CONFIG['arch'] =~ /mswin/
    platform = 'Win32'
else
    platform = 'Darwin'
end
bpVersion = "<%= $cmake["VersionString"] %>"
updatePkgName = "BrowserPlus_#{bpVersion}.bpkg"

puts "installing locally..."
$topDir = File.dirname(File.dirname(File.dirname(File.dirname(File.expand_path(__FILE__)))))
$workDir = File.join($topDir, "build", "pab_#{bpVersion}-#{platform}",
                     "work")
installerExe = File.join($workDir, "install", "BrowserPlusInstaller")
updatePkg = File.join($topDir, "build", updatePkgName)
if CONFIG['arch'] =~ /mswin/
    installerExe.gsub!(/\//, '\\')
    updatePkg.gsub!(/\//, '\\')
end

updateCmd = "#{installerExe} -nogui=1 -verbose=1 -pkg=#{updatePkg}"
puts updateCmd
if system(updateCmd)
    puts "BrowserPlusInstaller succeeded"
else
    puts "BrowserPlusInstaller failed with exitstatus " + $?.to_s
end

# and obliterate work directory 
if File.exist? $workDir
  puts "Removing artifacts build work directory"
  FileUtils.rm_rf($workDir)
end
